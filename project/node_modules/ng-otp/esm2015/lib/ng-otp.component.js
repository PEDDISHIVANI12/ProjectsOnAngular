/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, Input, Output, EventEmitter } from '@angular/core';
import { FormBuilder, Validators, FormControl } from '@angular/forms';
import { NgOtpService } from './ng-otp.service';
import { Subject, Subscription } from 'rxjs';
import { throttleTime } from 'rxjs/operators';
export class NgOtpComponent {
    /**
     * @param {?} formBuilder
     * @param {?} ngOtpService
     */
    constructor(formBuilder, ngOtpService) {
        this.formBuilder = formBuilder;
        this.ngOtpService = ngOtpService;
        this._allowedCharacters = /./;
        this._typeOfInput = 'text';
        this.keyboardType = 'text';
        this.otpOut = new EventEmitter();
        this.limitArray = [];
        this.isKeyAcceptable = true;
        this.changeFocus$ = new Subject();
        this.subscription = new Subscription();
        this.subscription.add(this.changeFocus$
            .pipe(throttleTime(50)).subscribe((/**
         * @param {?} index
         * @return {?}
         */
        (index) => { this.changeFocus(index); })));
    }
    /**
     * @param {?} el
     * @return {?}
     */
    set allowedCharacters(el) {
        if (el) {
            this._allowedCharacters = el;
        }
        else {
            this.throwErrorForUndefinedElement(el);
        }
    }
    /**
     * @param {?} type
     * @return {?}
     */
    set typeOfInput(type) {
        if (type) {
            this._typeOfInput = type;
            this.keyboardType = type === 'password' ? 'numeric' : 'text';
        }
        else {
            this.throwErrorForUndefinedElement(type);
        }
    }
    /**
     * @return {?}
     */
    get typeOfInput() {
        return this._typeOfInput;
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.limit = this.limit ? this.limit : 4;
        this.setFormBuilder();
    }
    /**
     * @return {?}
     */
    setFormBuilder() {
        this.otpForm = this.formBuilder.group({});
        this.limitArray = Array.from(Array(this.limit).keys());
        this.limitArray.map((/**
         * @param {?} element
         * @return {?}
         */
        (element) => {
            this.otpForm.addControl(`otp-${element}`, new FormControl('', Validators.required));
        }));
    }
    /**
     * @param {?} id
     * @return {?}
     */
    changeFocus(id) {
        console.log(this.isKeyAcceptable);
        if (!this.isKeyAcceptable) {
            this.isKeyAcceptable = true;
            return;
        }
        /** @type {?} */
        const currentElement = this.ngOtpService.getElement(id);
        if (id && this.ngOtpService.isEmptySting(currentElement.value)) {
            this.moveBackward(id);
        }
        else if (this.ngOtpService.isLastInput(id, this.limit - 1)) {
            currentElement.select();
            this.otpOut.emit(Object.values(this.otpForm.value).join(''));
        }
        else if (!this.ngOtpService.isEmptySting(currentElement.value)) {
            this.moveForward(id);
        }
    }
    /**
     * @private
     * @param {?} id
     * @return {?}
     */
    moveForward(id) {
        /** @type {?} */
        const nextElement = this.ngOtpService.getElement(id + 1);
        nextElement.focus();
    }
    /**
     * @private
     * @param {?} id
     * @return {?}
     */
    moveBackward(id) {
        /** @type {?} */
        const nextElement = this.ngOtpService.getElement(id - 1);
        nextElement.focus();
    }
    /**
     * @param {?} id
     * @return {?}
     */
    onFocus(id) {
        /** @type {?} */
        const currentElement = this.ngOtpService.getElement(id);
        currentElement.select();
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.subscription.unsubscribe();
    }
    /**
     * @param {?} event
     * @return {?}
     */
    onKeyDown(event) {
        if (event.key && (event.key !== 'Backspace' && event.key !== 'Delete')) {
            if (this._allowedCharacters) {
                if (this._allowedCharacters instanceof RegExp) {
                    if (!this._allowedCharacters.test(event.key)) {
                        this.isKeyAcceptable = false;
                        event.preventDefault();
                    }
                }
                else {
                    if (!this._allowedCharacters.includes(event.key)) {
                        this.isKeyAcceptable = false;
                        event.preventDefault();
                    }
                }
            }
        }
    }
    /**
     * @private
     * @template T
     * @param {?} element
     * @return {?}
     */
    throwErrorForUndefinedElement(element) {
        throw new Error(`Is not possibile set ${element} to this parameter`);
    }
}
NgOtpComponent.decorators = [
    { type: Component, args: [{
                selector: 'ng-otp',
                template: "<div\n  [formGroup]=\"otpForm\"\n  class=\"otp-wrap\"\n>\n  <input\n    [type]=\"typeOfInput\"\n    class=\"otp-input\"\n    maxlength=\"1\"\n    id=\"otp-{{i}}\"\n    *ngFor=\"let control of limitArray; let i = index\"\n    placeholder=\"-\"\n    (keyup)=\"changeFocus$.next(i)\"\n    (keydown)=\"onKeyDown($event)\"\n    (focusin)=\"onFocus(i)\"\n    formControlName=\"otp-{{i}}\"\n    [attr.inputmode]=\"keyboardType\"\n  >\n</div>",
                styles: [".otp-input{width:50px;height:45px;background:0 0;border:none;text-align:center;font-size:25px;font-weight:600;outline:0}.otp-input::-moz-selection{background:#f0f9ff}.otp-input::selection{background:#f0f9ff}.otp-wrap{border-bottom:2px solid #d7d7d7;max-width:-webkit-max-content;max-width:-moz-max-content;max-width:max-content}"]
            }] }
];
/** @nocollapse */
NgOtpComponent.ctorParameters = () => [
    { type: FormBuilder },
    { type: NgOtpService }
];
NgOtpComponent.propDecorators = {
    limit: [{ type: Input }],
    allowedCharacters: [{ type: Input }],
    typeOfInput: [{ type: Input }],
    otpOut: [{ type: Output }]
};
if (false) {
    /**
     * @type {?}
     * @private
     */
    NgOtpComponent.prototype._allowedCharacters;
    /**
     * @type {?}
     * @private
     */
    NgOtpComponent.prototype._typeOfInput;
    /** @type {?} */
    NgOtpComponent.prototype.keyboardType;
    /** @type {?} */
    NgOtpComponent.prototype.limit;
    /** @type {?} */
    NgOtpComponent.prototype.otpOut;
    /** @type {?} */
    NgOtpComponent.prototype.otpForm;
    /** @type {?} */
    NgOtpComponent.prototype.limitArray;
    /**
     * @type {?}
     * @private
     */
    NgOtpComponent.prototype.isKeyAcceptable;
    /** @type {?} */
    NgOtpComponent.prototype.changeFocus$;
    /**
     * @type {?}
     * @private
     */
    NgOtpComponent.prototype.subscription;
    /**
     * @type {?}
     * @private
     */
    NgOtpComponent.prototype.formBuilder;
    /**
     * @type {?}
     * @private
     */
    NgOtpComponent.prototype.ngOtpService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmctb3RwLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25nLW90cC8iLCJzb3VyY2VzIjpbImxpYi9uZy1vdHAuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBYSxNQUFNLEVBQUUsWUFBWSxFQUFxQixNQUFNLGVBQWUsQ0FBQztBQUNyRyxPQUFPLEVBQUUsV0FBVyxFQUFhLFVBQVUsRUFBRSxXQUFXLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNqRixPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDaEQsT0FBTyxFQUFFLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDN0MsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBTzlDLE1BQU0sT0FBTyxjQUFjOzs7OztJQW9DekIsWUFDVSxXQUF3QixFQUN4QixZQUEwQjtRQUQxQixnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQUN4QixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQXBDNUIsdUJBQWtCLEdBQW9CLEdBQUcsQ0FBQztRQUMxQyxpQkFBWSxHQUFtQyxNQUFNLENBQUM7UUFDOUQsaUJBQVksR0FBdUIsTUFBTSxDQUFDO1FBd0JoQyxXQUFNLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUcvQixlQUFVLEdBQUcsRUFBRSxDQUFDO1FBQ2Ysb0JBQWUsR0FBRyxJQUFJLENBQUM7UUFDL0IsaUJBQVksR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFDO1FBQ3JCLGlCQUFZLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQU14QyxJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsWUFBWTthQUNwQyxJQUFJLENBQ0gsWUFBWSxDQUFDLEVBQUUsQ0FBQyxDQUNqQixDQUFDLFNBQVM7Ozs7UUFDVCxDQUFDLEtBQWEsRUFBRSxFQUFFLEdBQUcs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RyxLQUFLLENBQUM7d0JBQzdCLEtBQUssQ0FBQyxjQUFjLEVBQUUsQ0FBQztxQkFDeEI7aUJBQ0Y7YUFDRjtTQUNGO0lBQ0gsQ0FBQzs7Ozs7OztJQUVPLDZCQUE2QixDQUFJLE9BQVU7UUFDakQsTUFBTSxJQUFJLEtBQUssQ0FBQyx3QkFBd0IsT0FBTyxvQkFBb0IsQ0FBQyxDQUFDO0lBQ3ZFLENBQUM7OztZQTNIRixTQUFTLFNBQUM7Z0JBQ1QsUUFBUSxFQUFFLFFBQVE7Z0JBQ2xCLDhiQUFzQzs7YUFFdkM7Ozs7WUFUUSxXQUFXO1lBQ1gsWUFBWTs7O29CQWVsQixLQUFLO2dDQUNMLEtBQUs7MEJBUUwsS0FBSztxQkFhTCxNQUFNOzs7Ozs7O0lBMUJQLDRDQUFrRDs7Ozs7SUFDbEQsc0NBQThEOztJQUM5RCxzQ0FBMEM7O0lBRTFDLCtCQUF1Qjs7SUFzQnZCLGdDQUFzQzs7SUFFdEMsaUNBQW1COztJQUNuQixvQ0FBdUI7Ozs7O0lBQ3ZCLHlDQUErQjs7SUFDL0Isc0NBQTZCOzs7OztJQUM3QixzQ0FBMEM7Ozs7O0lBR3hDLHFDQUFnQzs7Ozs7SUFDaEMsc0NBQWtDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBJbnB1dCwgT25EZXN0cm95LCBPdXRwdXQsIEV2ZW50RW1pdHRlciwgT25Jbml0LCBPbkNoYW5nZXMgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEZvcm1CdWlsZGVyLCBGb3JtR3JvdXAsIFZhbGlkYXRvcnMsIEZvcm1Db250cm9sIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHsgTmdPdHBTZXJ2aWNlIH0gZnJvbSAnLi9uZy1vdHAuc2VydmljZSc7XG5pbXBvcnQgeyBTdWJqZWN0LCBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHRocm90dGxlVGltZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnbmctb3RwJyxcbiAgdGVtcGxhdGVVcmw6ICcuL25nLW90cC5jb21wb25lbnQuaHRtbCcsXG4gIHN0eWxlVXJsczogWycuL25nLW90cC5jb21wb25lbnQuc2NzcyddXG59KVxuZXhwb3J0IGNsYXNzIE5nT3RwQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3kge1xuXG4gIHByaXZhdGUgX2FsbG93ZWRDaGFyYWN0ZXJzOiBzdHJpbmcgfCBSZWdFeHAgPSAvLi87XG4gIHByaXZhdGUgX3R5cGVPZklucHV0OiAndGV4dCcgfCAnbnVtYmVyJyB8ICdwYXNzd29yZCcgPSAndGV4dCc7XG4gIGtleWJvYXJkVHlwZTogJ251bWVyaWMnIHwgJ3RleHQnID0gJ3RleHQnO1xuXG4gIEBJbnB1dCgpIGxpbWl0OiBudW1iZXI7XG4gIEBJbnB1dCgpIHNldCBhbGxvd2VkQ2hhcmFjdGVycyhlbDogc3RyaW5nIHwgUmVnRXhwKSB7XG4gICAgaWYgKGVsKSB7XG4gICAgICB0aGlzLl9hbGxvd2VkQ2hhcmFjdGVycyA9IGVsO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnRocm93RXJyb3JGb3JVbmRlZmluZWRFbGVtZW50KGVsKTtcbiAgICB9XG4gIH1cblxuICBASW5wdXQoKSBzZXQgdHlwZU9mSW5wdXQodHlwZTogJ3RleHQnIHwgJ251bWJlcicgfCAncGFzc3dvcmQnKSB7XG4gICAgaWYgKHR5cGUpIHtcbiAgICAgIHRoaXMuX3R5cGVPZklucHV0ID0gdHlwZTtcbiAgICAgIHRoaXMua2V5Ym9hcmRUeXBlID0gdHlwZSA9PT0gJ3Bhc3N3b3JkJyA/ICdudW1lcmljJyA6ICd0ZXh0JztcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy50aHJvd0Vycm9yRm9yVW5kZWZpbmVkRWxlbWVudCh0eXBlKTtcbiAgICB9XG4gIH1cblxuICBnZXQgdHlwZU9mSW5wdXQoKTogJ3RleHQnIHwgJ251bWJlcicgfCAncGFzc3dvcmQnIHtcbiAgICByZXR1cm4gdGhpcy5fdHlwZU9mSW5wdXQ7XG4gIH1cblxuICBAT3V0cHV0KCkgb3RwT3V0ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gIG90cEZvcm06IEZvcm1Hcm91cDtcbiAgcHVibGljIGxpbWl0QXJyYXkgPSBbXTtcbiAgcHJpdmF0ZSBpc0tleUFjY2VwdGFibGUgPSB0cnVlO1xuICBjaGFuZ2VGb2N1cyQgPSBuZXcgU3ViamVjdCgpO1xuICBwcml2YXRlIHN1YnNjcmlwdGlvbiA9IG5ldyBTdWJzY3JpcHRpb24oKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGZvcm1CdWlsZGVyOiBGb3JtQnVpbGRlcixcbiAgICBwcml2YXRlIG5nT3RwU2VydmljZTogTmdPdHBTZXJ2aWNlXG4gICkge1xuICAgIHRoaXMuc3Vic2NyaXB0aW9uLmFkZCh0aGlzLmNoYW5nZUZvY3VzJFxuICAgICAgLnBpcGUoXG4gICAgICAgIHRocm90dGxlVGltZSg1MClcbiAgICAgICkuc3Vic2NyaWJlKFxuICAgICAgICAoaW5kZXg6IG51bWJlcikgPT4geyB0aGlzLmNoYW5nZUZvY3VzKGluZGV4KTsgfVxuICAgICAgKVxuICAgICk7XG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLmxpbWl0ID0gdGhpcy5saW1pdCA/IHRoaXMubGltaXQgOiA0O1xuICAgIHRoaXMuc2V0Rm9ybUJ1aWxkZXIoKTtcbiAgfVxuXG4gIHNldEZvcm1CdWlsZGVyKCkge1xuICAgIHRoaXMub3RwRm9ybSA9IHRoaXMuZm9ybUJ1aWxkZXIuZ3JvdXAoe30pO1xuICAgIHRoaXMubGltaXRBcnJheSA9IEFycmF5LmZyb20oQXJyYXkodGhpcy5saW1pdCkua2V5cygpKTtcbiAgICB0aGlzLmxpbWl0QXJyYXkubWFwKChlbGVtZW50KSA9PiB7XG4gICAgICB0aGlzLm90cEZvcm0uYWRkQ29udHJvbChgb3RwLSR7ZWxlbWVudH1gLCBuZXcgRm9ybUNvbnRyb2woJycsIFZhbGlkYXRvcnMucmVxdWlyZWQpKTtcbiAgICB9KTtcbiAgfVxuXG4gIGNoYW5nZUZvY3VzKGlkOiBudW1iZXIpIHtcbiAgICBjb25zb2xlLmxvZyh0aGlzLmlzS2V5QWNjZXB0YWJsZSk7XG4gICAgaWYgKCF0aGlzLmlzS2V5QWNjZXB0YWJsZSkge1xuICAgICAgdGhpcy5pc0tleUFjY2VwdGFibGUgPSB0cnVlO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBjdXJyZW50RWxlbWVudDogSFRNTElucHV0RWxlbWVudCA9IHRoaXMubmdPdHBTZXJ2aWNlLmdldEVsZW1lbnQoaWQpO1xuICAgIGlmIChpZCAmJiB0aGlzLm5nT3RwU2VydmljZS5pc0VtcHR5U3RpbmcoY3VycmVudEVsZW1lbnQudmFsdWUpKSB7XG4gICAgICB0aGlzLm1vdmVCYWNrd2FyZChpZCk7XG4gICAgfSBlbHNlIGlmICh0aGlzLm5nT3RwU2VydmljZS5pc0xhc3RJbnB1dChpZCwgdGhpcy5saW1pdCAtIDEpKSB7XG4gICAgICBjdXJyZW50RWxlbWVudC5zZWxlY3QoKTtcbiAgICAgIHRoaXMub3RwT3V0LmVtaXQoT2JqZWN0LnZhbHVlcyh0aGlzLm90cEZvcm0udmFsdWUpLmpvaW4oJycpKTtcbiAgICB9IGVsc2UgaWYgKCF0aGlzLm5nT3RwU2VydmljZS5pc0VtcHR5U3RpbmcoY3VycmVudEVsZW1lbnQudmFsdWUpKSB7XG4gICAgICB0aGlzLm1vdmVGb3J3YXJkKGlkKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG1vdmVGb3J3YXJkKGlkOiBudW1iZXIpIHtcbiAgICBjb25zdCBuZXh0RWxlbWVudDogSFRNTElucHV0RWxlbWVudCA9IHRoaXMubmdPdHBTZXJ2aWNlLmdldEVsZW1lbnQoaWQgKyAxKTtcbiAgICBuZXh0RWxlbWVudC5mb2N1cygpO1xuICB9XG5cbiAgcHJpdmF0ZSBtb3ZlQmFja3dhcmQoaWQ6IG51bWJlcikge1xuICAgIGNvbnN0IG5leHRFbGVtZW50OiBIVE1MSW5wdXRFbGVtZW50ID0gdGhpcy5uZ090cFNlcnZpY2UuZ2V0RWxlbWVudChpZCAtIDEpO1xuICAgIG5leHRFbGVtZW50LmZvY3VzKCk7XG4gIH1cblxuICBvbkZvY3VzKGlkKSB7XG4gICAgY29uc3QgY3VycmVudEVsZW1lbnQ6IEhUTUxJbnB1dEVsZW1lbnQgPSB0aGlzLm5nT3RwU2VydmljZS5nZXRFbGVtZW50KGlkKTtcbiAgICBjdXJyZW50RWxlbWVudC5zZWxlY3QoKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMuc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gIH1cblxuICBvbktleURvd24oZXZlbnQ6IEtleWJvYXJkRXZlbnQpIHtcbiAgICBpZiAoZXZlbnQua2V5ICYmIChldmVudC5rZXkgIT09ICdCYWNrc3BhY2UnICYmIGV2ZW50LmtleSAhPT0gJ0RlbGV0ZScpKSB7XG4gICAgICBpZiAodGhpcy5fYWxsb3dlZENoYXJhY3RlcnMpIHtcbiAgICAgICAgaWYgKHRoaXMuX2FsbG93ZWRDaGFyYWN0ZXJzIGluc3RhbmNlb2YgUmVnRXhwKSB7XG4gICAgICAgICAgaWYgKCF0aGlzLl9hbGxvd2VkQ2hhcmFjdGVycy50ZXN0KGV2ZW50LmtleSkpIHtcbiAgICAgICAgICAgIHRoaXMuaXNLZXlBY2NlcHRhYmxlID0gZmFsc2U7XG4gICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBpZiAoIXRoaXMuX2FsbG93ZWRDaGFyYWN0ZXJzLmluY2x1ZGVzKGV2ZW50LmtleSkpIHtcbiAgICAgICAgICAgIHRoaXMuaXNLZXlBY2NlcHRhYmxlID0gZmFsc2U7XG4gICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgdGhyb3dFcnJvckZvclVuZGVmaW5lZEVsZW1lbnQ8VD4oZWxlbWVudDogVCkge1xuICAgIHRocm93IG5ldyBFcnJvcihgSXMgbm90IHBvc3NpYmlsZSBzZXQgJHtlbGVtZW50fSB0byB0aGlzIHBhcmFtZXRlcmApO1xuICB9XG5cbn1cbiJdfQ==