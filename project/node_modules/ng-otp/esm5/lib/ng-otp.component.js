/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, Input, Output, EventEmitter } from '@angular/core';
import { FormBuilder, Validators, FormControl } from '@angular/forms';
import { NgOtpService } from './ng-otp.service';
import { Subject, Subscription } from 'rxjs';
import { throttleTime } from 'rxjs/operators';
var NgOtpComponent = /** @class */ (function () {
    function NgOtpComponent(formBuilder, ngOtpService) {
        var _this = this;
        this.formBuilder = formBuilder;
        this.ngOtpService = ngOtpService;
        this._allowedCharacters = /./;
        this._typeOfInput = 'text';
        this.keyboardType = 'text';
        this.otpOut = new EventEmitter();
        this.limitArray = [];
        this.isKeyAcceptable = true;
        this.changeFocus$ = new Subject();
        this.subscription = new Subscription();
        this.subscription.add(this.changeFocus$
            .pipe(throttleTime(50)).subscribe((/**
         * @param {?} index
         * @return {?}
         */
        function (index) { _this.changeFocus(index); })));
    }
    Object.defineProperty(NgOtpComponent.prototype, "allowedCharacters", {
        set: /**
         * @param {?} el
         * @return {?}
         */
        function (el) {
            if (el) {
                this._allowedCharacters = el;
            }
            else {
                this.throwErrorForUndefinedElement(el);
            }
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(NgOtpComponent.prototype, "typeOfInput", {
        get: /**
         * @return {?}
         */
        function () {
            return this._typeOfInput;
        },
        set: /**
         * @param {?} type
         * @return {?}
         */
        function (type) {
            if (type) {
                this._typeOfInput = type;
                this.keyboardType = type === 'password' ? 'numeric' : 'text';
            }
            else {
                this.throwErrorForUndefinedElement(type);
            }
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @return {?}
     */
    NgOtpComponent.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        this.limit = this.limit ? this.limit : 4;
        this.setFormBuilder();
    };
    /**
     * @return {?}
     */
    NgOtpComponent.prototype.setFormBuilder = /**
     * @return {?}
     */
    function () {
        var _this = this;
        this.otpForm = this.formBuilder.group({});
        this.limitArray = Array.from(Array(this.limit).keys());
        this.limitArray.map((/**
         * @param {?} element
         * @return {?}
         */
        function (element) {
            _this.otpForm.addControl("otp-" + element, new FormControl('', Validators.required));
        }));
    };
    /**
     * @param {?} id
     * @return {?}
     */
    NgOtpComponent.prototype.changeFocus = /**
     * @param {?} id
     * @return {?}
     */
    function (id) {
        console.log(this.isKeyAcceptable);
        if (!this.isKeyAcceptable) {
            this.isKeyAcceptable = true;
            return;
        }
        /** @type {?} */
        var currentElement = this.ngOtpService.getElement(id);
        if (id && this.ngOtpService.isEmptySting(currentElement.value)) {
            this.moveBackward(id);
        }
        else if (this.ngOtpService.isLastInput(id, this.limit - 1)) {
            currentElement.select();
            this.otpOut.emit(Object.values(this.otpForm.value).join(''));
        }
        else if (!this.ngOtpService.isEmptySting(currentElement.value)) {
            this.moveForward(id);
        }
    };
    /**
     * @private
     * @param {?} id
     * @return {?}
     */
    NgOtpComponent.prototype.moveForward = /**
     * @private
     * @param {?} id
     * @return {?}
     */
    function (id) {
        /** @type {?} */
        var nextElement = this.ngOtpService.getElement(id + 1);
        nextElement.focus();
    };
    /**
     * @private
     * @param {?} id
     * @return {?}
     */
    NgOtpComponent.prototype.moveBackward = /**
     * @private
     * @param {?} id
     * @return {?}
     */
    function (id) {
        /** @type {?} */
        var nextElement = this.ngOtpService.getElement(id - 1);
        nextElement.focus();
    };
    /**
     * @param {?} id
     * @return {?}
     */
    NgOtpComponent.prototype.onFocus = /**
     * @param {?} id
     * @return {?}
     */
    function (id) {
        /** @type {?} */
        var currentElement = this.ngOtpService.getElement(id);
        currentElement.select();
    };
    /**
     * @return {?}
     */
    NgOtpComponent.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        this.subscription.unsubscribe();
    };
    /**
     * @param {?} event
     * @return {?}
     */
    NgOtpComponent.prototype.onKeyDown = /**
     * @param {?} event
     * @return {?}
     */
    function (event) {
        if (event.key && (event.key !== 'Backspace' && event.key !== 'Delete')) {
            if (this._allowedCharacters) {
                if (this._allowedCharacters instanceof RegExp) {
                    if (!this._allowedCharacters.test(event.key)) {
                        this.isKeyAcceptable = false;
                        event.preventDefault();
                    }
                }
                else {
                    if (!this._allowedCharacters.includes(event.key)) {
                        this.isKeyAcceptable = false;
                        event.preventDefault();
                    }
                }
            }
        }
    };
    /**
     * @private
     * @template T
     * @param {?} element
     * @return {?}
     */
    NgOtpComponent.prototype.throwErrorForUndefinedElement = /**
     * @private
     * @template T
     * @param {?} element
     * @return {?}
     */
    function (element) {
        throw new Error("Is not possibile set " + element + " to this parameter");
    };
    NgOtpComponent.decorators = [
        { type: Component, args: [{
                    selector: 'ng-otp',
                    template: "<div\n  [formGroup]=\"otpForm\"\n  class=\"otp-wrap\"\n>\n  <input\n    [type]=\"typeOfInput\"\n    class=\"otp-input\"\n    maxlength=\"1\"\n    id=\"otp-{{i}}\"\n    *ngFor=\"let control of limitArray; let i = index\"\n    placeholder=\"-\"\n    (keyup)=\"changeFocus$.next(i)\"\n    (keydown)=\"onKeyDown($event)\"\n    (focusin)=\"onFocus(i)\"\n    formControlName=\"otp-{{i}}\"\n    [attr.inputmode]=\"keyboardType\"\n  >\n</div>",
                    styles: [".otp-input{width:50px;height:45px;background:0 0;border:none;text-align:center;font-size:25px;font-weight:600;outline:0}.otp-input::-moz-selection{background:#f0f9ff}.otp-input::selection{background:#f0f9ff}.otp-wrap{border-bottom:2px solid #d7d7d7;max-width:-webkit-max-content;max-width:-moz-max-content;max-width:max-content}"]
                }] }
    ];
    /** @nocollapse */
    NgOtpComponent.ctorParameters = function () { return [
        { type: FormBuilder },
        { type: NgOtpService }
    ]; };
    NgOtpComponent.propDecorators = {
        limit: [{ type: Input }],
        allowedCharacters: [{ type: Input }],
        typeOfInput: [{ type: Input }],
        otpOut: [{ type: Output }]
    };
    return NgOtpComponent;
}());
export { NgOtpComponent };
if (false) {
    /**
     * @type {?}
     * @private
     */
    NgOtpComponent.prototype._allowedCharacters;
    /**
     * @type {?}
     * @private
     */
    NgOtpComponent.prototype._typeOfInput;
    /** @type {?} */
    NgOtpComponent.prototype.keyboardType;
    /** @type {?} */
    NgOtpComponent.prototype.limit;
    /** @type {?} */
    NgOtpComponent.prototype.otpOut;
    /** @type {?} */
    NgOtpComponent.prototype.otpForm;
    /** @type {?} */
    NgOtpComponent.prototype.limitArray;
    /**
     * @type {?}
     * @private
     */
    NgOtpComponent.prototype.isKeyAcceptable;
    /** @type {?} */
    NgOtpComponent.prototype.changeFocus$;
    /**
     * @type {?}
     * @private
     */
    NgOtpComponent.prototype.subscription;
    /**
     * @type {?}
     * @private
     */
    NgOtpComponent.prototype.formBuilder;
    /**
     * @type {?}
     * @private
     */
    NgOtpComponent.prototype.ngOtpService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmctb3RwLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25nLW90cC8iLCJzb3VyY2VzIjpbImxpYi9uZy1vdHAuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBYSxNQUFNLEVBQUUsWUFBWSxFQUFxQixNQUFNLGVBQWUsQ0FBQztBQUNyRyxPQUFPLEVBQUUsV0FBVyxFQUFhLFVBQVUsRUFBRSxXQUFXLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNqRixPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDaEQsT0FBTyxFQUFFLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDN0MsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRTlDO0lBeUNFLHdCQUNVLFdBQXdCLEVBQ3hCLFlBQTBCO1FBRnBDLGlCQVdDO1FBVlMsZ0JBQVcsR0FBWCxXQUFXLENBQWE7UUFDeEIsaUJBQVksR0FBWixZQUFZLENBQWM7UUFwQzVCLHVCQUFrQixHQUFvQixHQUFHLENBQUM7UUFDMUMsaUJBQVksR0FBbUMsTUFBTSxDQUFDO1FBQzlELGlCQUFZLEdBQXVCLE1BQU0sQ0FBQztRQXdCaEMsV0FBTSxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7UUFHL0IsZUFBVSxHQUFHLEVBQUUsQ0FBQztRQUNmLG9CQUFlLEdBQUcsSUFBSSxDQUFDO1FBQy9CLGlCQUFZLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQztRQUNyQixpQkFBWSxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7UUFNeEMsSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFlBQVk7YUFDcEMsSUFBSSxDQUNILFlBQVksQ0FBQyxFQUFFLENBQUMsQ0FDakIsQ0FBQyxTQUFTOzs7O1FBQ1QsVUFBQyxLQUFhLElBQU8sS0FBSSxDQUFDLFdBQVcsQ0FB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QUFJLENBQUMsa0JBQWtCLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsRUFBRTt3QkFDaEQsSUFBSSxDQUFDLGVBQWUsR0FBRyxLQUFLLENBQUM7d0JBQzdCLEtBQUssQ0FBQyxjQUFjLEVBQUUsQ0FBQztxQkFDeEI7aUJBQ0Y7YUFDRjtTQUNGO0lBQ0gsQ0FBQzs7Ozs7OztJQUVPLHNEQUE2Qjs7Ozs7O0lBQXJDLFVBQXlDLE9BQVU7UUFDakQsTUFBTSxJQUFJLEtBQUssQ0FBQywwQkFBd0IsT0FBTyx1QkFBb0IsQ0FBQyxDQUFDO0lBQ3ZFLENBQUM7O2dCQTNIRixTQUFTLFNBQUM7b0JBQ1QsUUFBUSxFQUFFLFFBQVE7b0JBQ2xCLDhiQUFzQzs7aUJBRXZDOzs7O2dCQVRRLFdBQVc7Z0JBQ1gsWUFBWTs7O3dCQWVsQixLQUFLO29DQUNMLEtBQUs7OEJBUUwsS0FBSzt5QkFhTCxNQUFNOztJQTRGVCxxQkFBQztDQUFBLEFBN0hELElBNkhDO1NBeEhZLGNBQWM7Ozs7OztJQUV6Qiw0Q0FBa0Q7Ozs7O0lBQ2xELHNDQUE4RDs7SUFDOUQsc0NBQTBDOztJQUUxQywrQkFBdUI7O0lBc0J2QixnQ0FBc0M7O0lBRXRDLGlDQUFtQjs7SUFDbkIsb0NBQXVCOzs7OztJQUN2Qix5Q0FBK0I7O0lBQy9CLHNDQUE2Qjs7Ozs7SUFDN0Isc0NBQTBDOzs7OztJQUd4QyxxQ0FBZ0M7Ozs7O0lBQ2hDLHNDQUFrQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgSW5wdXQsIE9uRGVzdHJveSwgT3V0cHV0LCBFdmVudEVtaXR0ZXIsIE9uSW5pdCwgT25DaGFuZ2VzIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBGb3JtQnVpbGRlciwgRm9ybUdyb3VwLCBWYWxpZGF0b3JzLCBGb3JtQ29udHJvbCB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IE5nT3RwU2VydmljZSB9IGZyb20gJy4vbmctb3RwLnNlcnZpY2UnO1xuaW1wb3J0IHsgU3ViamVjdCwgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyB0aHJvdHRsZVRpbWUgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ25nLW90cCcsXG4gIHRlbXBsYXRlVXJsOiAnLi9uZy1vdHAuY29tcG9uZW50Lmh0bWwnLFxuICBzdHlsZVVybHM6IFsnLi9uZy1vdHAuY29tcG9uZW50LnNjc3MnXVxufSlcbmV4cG9ydCBjbGFzcyBOZ090cENvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95IHtcblxuICBwcml2YXRlIF9hbGxvd2VkQ2hhcmFjdGVyczogc3RyaW5nIHwgUmVnRXhwID0gLy4vO1xuICBwcml2YXRlIF90eXBlT2ZJbnB1dDogJ3RleHQnIHwgJ251bWJlcicgfCAncGFzc3dvcmQnID0gJ3RleHQnO1xuICBrZXlib2FyZFR5cGU6ICdudW1lcmljJyB8ICd0ZXh0JyA9ICd0ZXh0JztcblxuICBASW5wdXQoKSBsaW1pdDogbnVtYmVyO1xuICBASW5wdXQoKSBzZXQgYWxsb3dlZENoYXJhY3RlcnMoZWw6IHN0cmluZyB8IFJlZ0V4cCkge1xuICAgIGlmIChlbCkge1xuICAgICAgdGhpcy5fYWxsb3dlZENoYXJhY3RlcnMgPSBlbDtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy50aHJvd0Vycm9yRm9yVW5kZWZpbmVkRWxlbWVudChlbCk7XG4gICAgfVxuICB9XG5cbiAgQElucHV0KCkgc2V0IHR5cGVPZklucHV0KHR5cGU6ICd0ZXh0JyB8ICdudW1iZXInIHwgJ3Bhc3N3b3JkJykge1xuICAgIGlmICh0eXBlKSB7XG4gICAgICB0aGlzLl90eXBlT2ZJbnB1dCA9IHR5cGU7XG4gICAgICB0aGlzLmtleWJvYXJkVHlwZSA9IHR5cGUgPT09ICdwYXNzd29yZCcgPyAnbnVtZXJpYycgOiAndGV4dCc7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMudGhyb3dFcnJvckZvclVuZGVmaW5lZEVsZW1lbnQodHlwZSk7XG4gICAgfVxuICB9XG5cbiAgZ2V0IHR5cGVPZklucHV0KCk6ICd0ZXh0JyB8ICdudW1iZXInIHwgJ3Bhc3N3b3JkJyB7XG4gICAgcmV0dXJuIHRoaXMuX3R5cGVPZklucHV0O1xuICB9XG5cbiAgQE91dHB1dCgpIG90cE91dCA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICBvdHBGb3JtOiBGb3JtR3JvdXA7XG4gIHB1YmxpYyBsaW1pdEFycmF5ID0gW107XG4gIHByaXZhdGUgaXNLZXlBY2NlcHRhYmxlID0gdHJ1ZTtcbiAgY2hhbmdlRm9jdXMkID0gbmV3IFN1YmplY3QoKTtcbiAgcHJpdmF0ZSBzdWJzY3JpcHRpb24gPSBuZXcgU3Vic2NyaXB0aW9uKCk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBmb3JtQnVpbGRlcjogRm9ybUJ1aWxkZXIsXG4gICAgcHJpdmF0ZSBuZ090cFNlcnZpY2U6IE5nT3RwU2VydmljZVxuICApIHtcbiAgICB0aGlzLnN1YnNjcmlwdGlvbi5hZGQodGhpcy5jaGFuZ2VGb2N1cyRcbiAgICAgIC5waXBlKFxuICAgICAgICB0aHJvdHRsZVRpbWUoNTApXG4gICAgICApLnN1YnNjcmliZShcbiAgICAgICAgKGluZGV4OiBudW1iZXIpID0+IHsgdGhpcy5jaGFuZ2VGb2N1cyhpbmRleCk7IH1cbiAgICAgIClcbiAgICApO1xuICB9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgdGhpcy5saW1pdCA9IHRoaXMubGltaXQgPyB0aGlzLmxpbWl0IDogNDtcbiAgICB0aGlzLnNldEZvcm1CdWlsZGVyKCk7XG4gIH1cblxuICBzZXRGb3JtQnVpbGRlcigpIHtcbiAgICB0aGlzLm90cEZvcm0gPSB0aGlzLmZvcm1CdWlsZGVyLmdyb3VwKHt9KTtcbiAgICB0aGlzLmxpbWl0QXJyYXkgPSBBcnJheS5mcm9tKEFycmF5KHRoaXMubGltaXQpLmtleXMoKSk7XG4gICAgdGhpcy5saW1pdEFycmF5Lm1hcCgoZWxlbWVudCkgPT4ge1xuICAgICAgdGhpcy5vdHBGb3JtLmFkZENvbnRyb2woYG90cC0ke2VsZW1lbnR9YCwgbmV3IEZvcm1Db250cm9sKCcnLCBWYWxpZGF0b3JzLnJlcXVpcmVkKSk7XG4gICAgfSk7XG4gIH1cblxuICBjaGFuZ2VGb2N1cyhpZDogbnVtYmVyKSB7XG4gICAgY29uc29sZS5sb2codGhpcy5pc0tleUFjY2VwdGFibGUpO1xuICAgIGlmICghdGhpcy5pc0tleUFjY2VwdGFibGUpIHtcbiAgICAgIHRoaXMuaXNLZXlBY2NlcHRhYmxlID0gdHJ1ZTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgY3VycmVudEVsZW1lbnQ6IEhUTUxJbnB1dEVsZW1lbnQgPSB0aGlzLm5nT3RwU2VydmljZS5nZXRFbGVtZW50KGlkKTtcbiAgICBpZiAoaWQgJiYgdGhpcy5uZ090cFNlcnZpY2UuaXNFbXB0eVN0aW5nKGN1cnJlbnRFbGVtZW50LnZhbHVlKSkge1xuICAgICAgdGhpcy5tb3ZlQmFja3dhcmQoaWQpO1xuICAgIH0gZWxzZSBpZiAodGhpcy5uZ090cFNlcnZpY2UuaXNMYXN0SW5wdXQoaWQsIHRoaXMubGltaXQgLSAxKSkge1xuICAgICAgY3VycmVudEVsZW1lbnQuc2VsZWN0KCk7XG4gICAgICB0aGlzLm90cE91dC5lbWl0KE9iamVjdC52YWx1ZXModGhpcy5vdHBGb3JtLnZhbHVlKS5qb2luKCcnKSk7XG4gICAgfSBlbHNlIGlmICghdGhpcy5uZ090cFNlcnZpY2UuaXNFbXB0eVN0aW5nKGN1cnJlbnRFbGVtZW50LnZhbHVlKSkge1xuICAgICAgdGhpcy5tb3ZlRm9yd2FyZChpZCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBtb3ZlRm9yd2FyZChpZDogbnVtYmVyKSB7XG4gICAgY29uc3QgbmV4dEVsZW1lbnQ6IEhUTUxJbnB1dEVsZW1lbnQgPSB0aGlzLm5nT3RwU2VydmljZS5nZXRFbGVtZW50KGlkICsgMSk7XG4gICAgbmV4dEVsZW1lbnQuZm9jdXMoKTtcbiAgfVxuXG4gIHByaXZhdGUgbW92ZUJhY2t3YXJkKGlkOiBudW1iZXIpIHtcbiAgICBjb25zdCBuZXh0RWxlbWVudDogSFRNTElucHV0RWxlbWVudCA9IHRoaXMubmdPdHBTZXJ2aWNlLmdldEVsZW1lbnQoaWQgLSAxKTtcbiAgICBuZXh0RWxlbWVudC5mb2N1cygpO1xuICB9XG5cbiAgb25Gb2N1cyhpZCkge1xuICAgIGNvbnN0IGN1cnJlbnRFbGVtZW50OiBIVE1MSW5wdXRFbGVtZW50ID0gdGhpcy5uZ090cFNlcnZpY2UuZ2V0RWxlbWVudChpZCk7XG4gICAgY3VycmVudEVsZW1lbnQuc2VsZWN0KCk7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICB0aGlzLnN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICB9XG5cbiAgb25LZXlEb3duKGV2ZW50OiBLZXlib2FyZEV2ZW50KSB7XG4gICAgaWYgKGV2ZW50LmtleSAmJiAoZXZlbnQua2V5ICE9PSAnQmFja3NwYWNlJyAmJiBldmVudC5rZXkgIT09ICdEZWxldGUnKSkge1xuICAgICAgaWYgKHRoaXMuX2FsbG93ZWRDaGFyYWN0ZXJzKSB7XG4gICAgICAgIGlmICh0aGlzLl9hbGxvd2VkQ2hhcmFjdGVycyBpbnN0YW5jZW9mIFJlZ0V4cCkge1xuICAgICAgICAgIGlmICghdGhpcy5fYWxsb3dlZENoYXJhY3RlcnMudGVzdChldmVudC5rZXkpKSB7XG4gICAgICAgICAgICB0aGlzLmlzS2V5QWNjZXB0YWJsZSA9IGZhbHNlO1xuICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaWYgKCF0aGlzLl9hbGxvd2VkQ2hhcmFjdGVycy5pbmNsdWRlcyhldmVudC5rZXkpKSB7XG4gICAgICAgICAgICB0aGlzLmlzS2V5QWNjZXB0YWJsZSA9IGZhbHNlO1xuICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHRocm93RXJyb3JGb3JVbmRlZmluZWRFbGVtZW50PFQ+KGVsZW1lbnQ6IFQpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYElzIG5vdCBwb3NzaWJpbGUgc2V0ICR7ZWxlbWVudH0gdG8gdGhpcyBwYXJhbWV0ZXJgKTtcbiAgfVxuXG59XG4iXX0=